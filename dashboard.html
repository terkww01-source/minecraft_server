<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت سرور ماینکرفت</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazir:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Vazir', sans-serif; }
        .status-running { background: linear-gradient(45deg, #10b981, #059669); }
        .status-offline { background: linear-gradient(45deg, #ef4444, #dc2626); }
        .status-starting { background: linear-gradient(45deg, #f59e0b, #d97706); }
        .status-unknown { background: linear-gradient(45deg, #6b7280, #4b5563); }
        .pulse-green { animation: pulse-green 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .pulse-red { animation: pulse-red 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .pulse-yellow { animation: pulse-yellow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse-green { 0%, 100% { background-color: rgb(34 197 94 / 1); } 50% { background-color: rgb(34 197 94 / 0.7); } }
        @keyframes pulse-red { 0%, 100% { background-color: rgb(239 68 68 / 1); } 50% { background-color: rgb(239 68 68 / 0.7); } }
        @keyframes pulse-yellow { 0%, 100% { background-color: rgb(245 158 11 / 1); } 50% { background-color: rgb(245 158 11 / 0.7); } }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen" x-data="dashboard()" x-init="init()">
    <div class="container mx-auto px-4 py-8">
        <!-- هدر -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2">🎮 مدیریت سرور ماینکرفت</h1>
            <p class="text-gray-400">مانیتورینگ و کنترل خودکار سرور</p>
        </div>

        <!-- وضعیت اصلی -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- وضعیت سرور -->
            <div class="bg-gray-800 rounded-lg p-6 text-center">
                <div class="mb-4">
                    <div class="w-20 h-20 mx-auto rounded-full flex items-center justify-center text-3xl"
                         :class="getStatusClass(status.status)">
                        <i :class="getStatusIcon(status.status)"></i>
                    </div>
                </div>
                <h3 class="text-xl font-semibold mb-2">وضعیت سرور</h3>
                <p class="text-2xl font-bold" x-text="getStatusText(status.status)"></p>
                <p class="text-sm text-gray-400 mt-2" x-show="status.last_status_change">
                    آخرین تغییر: <span x-text="formatTime(status.last_status_change)"></span>
                </p>
            </div>

            <!-- آمار کلیک -->
            <div class="bg-gray-800 rounded-lg p-6 text-center">
                <div class="mb-4">
                    <div class="w-20 h-20 mx-auto rounded-full bg-blue-600 flex items-center justify-center text-3xl">
                        <i class="fas fa-mouse-pointer"></i>
                    </div>
                </div>
                <h3 class="text-xl font-semibold mb-2">آمار کلیک</h3>
                <div class="space-y-1">
                    <p>کل: <span class="font-bold text-blue-400" x-text="status.click_count || 0"></span></p>
                    <p>موفق: <span class="font-bold text-green-400" x-text="status.successful_clicks || 0"></span></p>
                    <p>ناموفق: <span class="font-bold text-red-400" x-text="status.failed_clicks || 0"></span></p>
                </div>
            </div>

            <!-- زمان کار -->
            <div class="bg-gray-800 rounded-lg p-6 text-center">
                <div class="mb-4">
                    <div class="w-20 h-20 mx-auto rounded-full bg-purple-600 flex items-center justify-center text-3xl">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>
                <h3 class="text-xl font-semibold mb-2">زمان کار</h3>
                <p class="text-2xl font-bold text-purple-400" x-text="status.uptime || '0:00:00'"></p>
                <p class="text-sm text-gray-400 mt-2">آخرین بروزرسانی: <span x-text="formatTime(status.last_check)"></span></p>
            </div>
        </div>

        <!-- کنترل‌ها -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- کنترل دستی -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-xl font-semibold mb-4">
                    <i class="fas fa-gamepad mr-2"></i>
                    کنترل دستی
                </h3>
                <div class="space-y-4">
                    <button @click="startServer()" 
                            :disabled="loading || status.status === 'running'"
                            :class="status.status === 'running' ? 'bg-gray-600 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'"
                            class="w-full py-3 px-4 rounded-lg font-medium transition-colors">
                        <i class="fas fa-play mr-2"></i>
                        <span x-show="!loading">روشن کردن سرور</span>
                        <span x-show="loading">در حال انجام...</span>
                    </button>
                    
                    <button @click="stopServer()" 
                            :disabled="loading || status.status === 'offline'"
                            :class="status.status === 'offline' ? 'bg-gray-600 cursor-not-allowed' : 'bg-red-600 hover:bg-red-700'"
                            class="w-full py-3 px-4 rounded-lg font-medium transition-colors">
                        <i class="fas fa-stop mr-2"></i>
                        <span x-show="!loading">خاموش کردن سرور</span>
                        <span x-show="loading">در حال انجام...</span>
                    </button>
                    
                    <button @click="forceCheck()" 
                            :disabled="loading"
                            class="w-full py-3 px-4 rounded-lg font-medium bg-blue-600 hover:bg-blue-700 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>
                        <span x-show="!loading">بررسی وضعیت</span>
                        <span x-show="loading">در حال بررسی...</span>
                    </button>
                </div>
            </div>

            <!-- تنظیمات خودکار -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-xl font-semibold mb-4">
                    <i class="fas fa-cogs mr-2"></i>
                    تنظیمات خودکار
                </h3>
                <div class="space-y-4">
                    <!-- فعال/غیرفعال کردن -->
                    <div class="flex items-center justify-between">
                        <span>بررسی خودکار</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" x-model="status.auto_check_active" @change="toggleAutoCheck()" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:right-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                        </label>
                    </div>
                    
                    <!-- فاصله زمانی -->
                    <div>
                        <label class="block text-sm font-medium mb-2">فاصله زمانی (دقیقه)</label>
                        <div class="flex space-x-2 space-x-reverse">
                            <input type="number" x-model="checkInterval.min" min="1" max="60" 
                                   class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white">
                            <span class="self-center">تا</span>
                            <input type="number" x-model="checkInterval.max" min="1" max="60"
                                   class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white">
                        </div>
                        <button @click="updateCheckInterval()" 
                                class="w-full mt-2 py-2 px-4 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm">
                            اعمال تغییرات
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- اطلاعات تفصیلی -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8">
            <h3 class="text-xl font-semibold mb-4">
                <i class="fas fa-info-circle mr-2"></i>
                اطلاعات تفصیلی
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div>
                    <strong>آخرین عملیات:</strong>
                    <span x-text="status.last_action || 'هیچ عملیاتی انجام نشده'" class="text-gray-300"></span>
                </div>
                <div>
                    <strong>بررسی بعدی:</strong>
                    <span x-text="status.next_check ? formatTime(status.next_check) : 'غیرفعال'" class="text-gray-300"></span>
                </div>
                <div>
                    <strong>دکمه START موجود:</strong>
                    <span :class="status.start_button_available ? 'text-green-400' : 'text-red-400'">
                        <i :class="status.start_button_available ? 'fas fa-check' : 'fas fa-times'"></i>
                        <span x-text="status.start_button_available ? 'بله' : 'خیر'"></span>
                    </span>
                </div>
                <div>
                    <strong>دکمه STOP موجود:</strong>
                    <span :class="status.stop_button_available ? 'text-green-400' : 'text-red-400'">
                        <i :class="status.stop_button_available ? 'fas fa-check' : 'fas fa-times'"></i>
                        <span x-text="status.stop_button_available ? 'بله' : 'خیر'"></span>
                    </span>
                </div>
            </div>
        </div>

        <!-- لاگ -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h3 class="text-xl font-semibold mb-4">
                <i class="fas fa-list mr-2"></i>
                لاگ عملیات
            </h3>
            <div class="bg-gray-900 rounded-lg p-4 h-64 overflow-y-auto">
                <div x-show="logs.length === 0" class="text-gray-500 text-center py-8">
                    هیچ لاگی موجود نیست
                </div>
                <template x-for="log in logs.slice().reverse()" :key="log.id">
                    <div class="mb-2 p-2 rounded" :class="getLogClass(log.type)">
                        <span class="text-xs text-gray-400" x-text="log.time"></span>
                        <span x-text="log.message" class="mr-2"></span>
                    </div>
                </template>
            </div>
            <button @click="clearLogs()" class="mt-2 px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm">
                پاک کردن لاگ
            </button>
        </div>
    </div>

    <!-- نمایش پیام -->
    <div x-show="message" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform translate-y-2"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 transform translate-y-0"
         x-transition:leave-end="opacity-0 transform translate-y-2"
         class="fixed top-4 left-4 right-4 z-50 max-w-md mx-auto">
        <div :class="messageType === 'success' ? 'bg-green-600' : 'bg-red-600'" 
             class="rounded-lg p-4 text-white shadow-lg">
            <div class="flex items-center">
                <i :class="messageType === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle'" class="mr-2"></i>
                <span x-text="message"></span>
            </div>
        </div>
    </div>

    <script>
        function dashboard() {
            return {
                status: {
                    status: 'unknown',
                    last_check: null,
                    next_check: null,
                    last_action: null,
                    auto_check_active: true,
                    check_interval_minutes: 2,
                    click_count: 0,
                    successful_clicks: 0,
                    failed_clicks: 0,
                    uptime: '0:00:00',
                    last_status_change: null,
                    start_button_available: false,
                    stop_button_available: false
                },
                checkInterval: { min: 1, max: 3 },
                loading: false,
                message: '',
                messageType: 'info',
                logs: [],
                logId: 0,

                init() {
                    this.loadStatus();
                    // بروزرسانی هر 5 ثانیه
                    setInterval(() => this.loadStatus(), 5000);
                },

                async loadStatus() {
                    try {
                        const response = await fetch('/api/status');
                        const data = await response.json();
                        
                        // بررسی تغییر وضعیت برای لاگ
                        if (this.status.status !== data.status) {
                            this.addLog('info', `وضعیت سرور تغییر کرد: ${this.getStatusText(data.status)}`);
                        }
                        
                        this.status = { ...this.status, ...data };
                    } catch (error) {
                        this.addLog('error', 'خطا در دریافت وضعیت سرور');
                        console.error('خطا در دریافت وضعیت:', error);
                    }
                },

                async startServer() {
                    this.loading = true;
                    try {
                        const response = await fetch('/api/start', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        const data = await response.json();
                        
                        this.showMessage(data.message, data.success ? 'success' : 'error');
                        this.addLog(data.success ? 'success' : 'error', data.message);
                        
                        if (data.success) {
                            setTimeout(() => this.loadStatus(), 2000);
                        }
                    } catch (error) {
                        this.showMessage('خطا در ارتباط با سرور', 'error');
                        this.addLog('error', 'خطا در ارتباط با سرور');
                    }
                    this.loading = false;
                },

                async stopServer() {
                    this.loading = true;
                    try {
                        const response = await fetch('/api/stop', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        const data = await response.json();
                        
                        this.showMessage(data.message, data.success ? 'success' : 'error');
                        this.addLog(data.success ? 'success' : 'error', data.message);
                        
                        if (data.success) {
                            setTimeout(() => this.loadStatus(), 2000);
                        }
                    } catch (error) {
                        this.showMessage('خطا در ارتباط با سرور', 'error');
                        this.addLog('error', 'خطا در ارتباط با سرور');
                    }
                    this.loading = false;
                },

                async forceCheck() {
                    this.loading = true;
                    try {
                        const response = await fetch('/api/force_check', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        const data = await response.json();
                        
                        this.showMessage(data.message, data.success ? 'success' : 'error');
                        this.addLog(data.success ? 'info' : 'error', data.message);
                        
                        if (data.success && data.status) {
                            this.status = { ...this.status, ...data.status };
                        }
                    } catch (error) {
                        this.showMessage('خطا در بررسی وضعیت', 'error');
                        this.addLog('error', 'خطا در بررسی وضعیت');
                    }
                    this.loading = false;
                },

                async toggleAutoCheck() {
                    try {
                        const response = await fetch('/api/toggle_auto_check', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ active: this.status.auto_check_active })
                        });
                        const data = await response.json();
                        
                        this.showMessage(data.message, data.success ? 'success' : 'error');
                        this.addLog(data.success ? 'info' : 'error', data.message);
                    } catch (error) {
                        this.showMessage('خطا در تغییر تنظیمات', 'error');
                        this.addLog('error', 'خطا در تغییر تنظیمات');
                    }
                },

                async updateCheckInterval() {
                    try {
                        const response = await fetch('/api/set_check_interval', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                min: parseInt(this.checkInterval.min),
                                max: parseInt(this.checkInterval.max)
                            })
                        });
                        const data = await response.json();
                        
                        this.showMessage(data.message, data.success ? 'success' : 'error');
                        this.addLog(data.success ? 'info' : 'error', data.message);
                    } catch (error) {
                        this.showMessage('خطا در تنظیم فاصله زمانی', 'error');
                        this.addLog('error', 'خطا در تنظیم فاصله زمانی');
                    }
                },

                getStatusClass(status) {
                    const classes = {
                        'running': 'status-running pulse-green',
                        'offline': 'status-offline pulse-red',
                        'starting': 'status-starting pulse-yellow',
                        'unknown': 'status-unknown'
                    };
                    return classes[status] || classes.unknown;
                },

                getStatusIcon(status) {
                    const icons = {
                        'running': 'fas fa-play',
                        'offline': 'fas fa-stop',
                        'starting': 'fas fa-spinner fa-spin',
                        'unknown': 'fas fa-question'
                    };
                    return icons[status] || icons.unknown;
                },

                getStatusText(status) {
                    const texts = {
                        'running': 'در حال اجرا',
                        'offline': 'خاموش',
                        'starting': 'در حال شروع',
                        'unknown': 'نامعلوم',
                        'initializing': 'در حال راه‌اندازی'
                    };
                    return texts[status] || 'نامعلوم';
                },

                getLogClass(type) {
                    const classes = {
                        'success': 'bg-green-600 bg-opacity-20 border border-green-600',
                        'error': 'bg-red-600 bg-opacity-20 border border-red-600',
                        'info': 'bg-blue-600 bg-opacity-20 border border-blue-600'
                    };
                    return classes[type] || classes.info;
                },

                formatTime(timeString) {
                    if (!timeString) return 'نامعلوم';
                    try {
                        const date = new Date(timeString);
                        return date.toLocaleString('fa-IR');
                    } catch {
                        return 'نامعلوم';
                    }
                },

                showMessage(text, type = 'info') {
                    this.message = text;
                    this.messageType = type;
                    setTimeout(() => {
                        this.message = '';
                    }, 5000);
                },

                addLog(type, message) {
                    this.logs.push({
                        id: this.logId++,
                        type: type,
                        message: message,
                        time: new Date().toLocaleTimeString('fa-IR')
                    });
                    
                    // نگه داشتن حداکثر 50 لاگ
                    if (this.logs.length > 50) {
                        this.logs = this.logs.slice(-50);
                    }
                },

                clearLogs() {
                    this.logs = [];
                    this.addLog('info', 'لاگ پاک شد');
                }
            }
        }
    </script>
</body>
</html>